#!/usr/bin/env ruby

# frozen_string_literal: true

require "active_support/core_ext/string/inflections"
require "date"
require "erb"
require "kramdown"
require "kramdown-parser-gfm"
require "phlex"

module PageComponents
  class Layout < Phlex::View
    def initialize(title)
      @title_text = title
    end

    def template(&block)
      doctype

      html do
        head do
          meta charset: "utf-8"
          meta name: "viewport", content: "width=device-width, initial-scale=1"
          link rel: "preload", href: "/static/roboto_slab_regular.ttf", as: "font", crossorigin: true
          link rel: "preload", href: "/static/fira_code_regular.ttf", as: "font", crossorigin: true
          link rel: "stylesheet", href: "/static/main.css"
          title "#{title_text} | jai.moe"
        end

        body do
          nav do
            a(href: "/") { "jai.moe" }
            a(href: "https://twitter.com/jai_1337") { "twitter" }
            a(href: "https://github.com/jai-x") { "github" }
            a(href: "mailto:jai@jai.moe") { "email" }
            div class: "nav-border"
          end

          main { yield_content(&block) }
        end
      end
    end

    private

    attr_reader :title_text, :content_view
  end

  class Markdown < Phlex::View
    def initialize(content)
      @content = content
    end

    def template
      raw Kramdown::Document.new(content, input: "GFM", hard_wrap: false).to_html
    end

    private

    attr_reader :content
  end
end

class ApplicationPage < Phlex::View
  include PageComponents
  register_element :hr
end

class PostPage < ApplicationPage
  def initialize(post)
    @post = post
  end

  def path
    "posts/#{post.slug}.html"
  end

  def template
    render Layout.new(post.title) do
      render Markdown.new(post.markdown)
    end
  end

  private

  attr_reader :post
end

class NotFoundPage < ApplicationPage
  def path
    "404.html"
  end

  def template
    render Layout.new('404') do
      h1 "404"
      p "Page not found"
    end
  end
end

class HomePage < ApplicationPage
  def initialize(posts)
    @posts = posts
  end

  def path
    "index.html"
  end

  def template
    render Layout.new('home') do
      section class: "home-section" do
        h2 "posts"
        posts.each do |post|
          h3 { a post.title, href: "/posts/#{post.slug}.html" }
          p { strong post.date }
        end
      end

      hr

      section class: "home-section" do
        h2 "ideas"
        render Markdown.new(ideas)
      end
    end
  end

  private

  attr_reader :posts

  def ideas
    @ideas ||= File.read("./ideas.md")
  end
end

class Post
  attr_reader :markdown

  def initialize(md_path)
    @markdown = File.read(md_path)
  end

  def title
    @title ||= markdown.lines[0].gsub("#", "").strip.downcase
  end

  def slug
    @slug ||= title.parameterize
  end

  def date
    @date ||= Date.parse(markdown.lines[1].gsub("*", "").strip)
  end

  # Sort comparison by date
  def <=>(other)
    date <=> other.date
  end
end

class PageWriter
  def initialize(prefix = "./")
    @prefix = prefix
  end

  def write(view)
    path = File.join(prefix, view.path)

    File.open(path, "w") do |file|
      file.write(view.call)
      puts "Rendered page: #{path}"
    end
  end

  private

  attr_reader :prefix
end

class Website
  def self.generate
    writer = PageWriter.new("./www")

    # Render 404 page
    writer.write NotFoundPage.new

    # Generate and render posts
    posts = Dir["./posts/*.md"].map { |src| Post.new(src) }
                               .sort
                               .reverse
                               .each { |post| writer.write PostPage.new(post) }

    # Render home page
    writer.write HomePage.new(posts)
  end
end

Website.generate
